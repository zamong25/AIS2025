# 🏛️ 델파이 트레이딩 시스템 - 시스템 아키텍처

## 📋 시스템 개요

델파이는 4명의 AI 에이전트가 협업하여 거래 결정을 내리는 멀티 에이전트 시스템입니다.

```
┌─────────────────────────────────────────────────────────┐
│                    사용자 인터페이스                      │
│                 (Dashboard / Discord)                    │
└─────────────────────────────────────────────────────────┘
                            │
┌─────────────────────────────────────────────────────────┐
│                  델파이 오케스트레이터                    │
│                    (main.py)                            │
└─────────────────────────────────────────────────────────┘
                            │
        ┌───────────────────┴───────────────────┐
        │                                       │
┌───────────────┐  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐
│  아르키메데스  │  │  헤로도토스   │  │  피타고라스   │  │     제논      │
│  (차티스트)   │  │ (저널리스트)  │  │   (퀀트)     │  │  (스토익)     │
└───────────────┘  └───────────────┘  └───────────────┘  └───────────────┘
        │                  │                  │                  │
        └──────────────────┴──────────────────┴──────────────────┘
                                    │
                          ┌─────────────────┐
                          │      솔론       │
                          │  (신디사이저)   │
                          └─────────────────┘
                                    │
                          ┌─────────────────┐
                          │   거래 실행기   │
                          │ (TradeExecutor) │
                          └─────────────────┘
                                    │
                          ┌─────────────────┐
                          │  바이낸스 API   │
                          └─────────────────┘
```

## 🤖 에이전트 상세

### 1. 아르키메데스 (차티스트)
- **역할**: 기술적 차트 분석
- **입력**: 5분, 15분, 1시간, 1일 차트 이미지
- **출력**: 추세, 지지/저항, 시나리오 분석
- **특징**: Lux Algo 지표 기반 정밀 분석

### 2. 헤로도토스 (저널리스트)
- **역할**: 뉴스 및 시장 정서 분석
- **입력**: 최신 뉴스, 소셜 미디어, 이벤트
- **출력**: 내러티브, 감성, 시간축별 영향도
- **특징**: 즉각/단기/장기 영향 구분

### 3. 피타고라스 (퀀트)
- **역할**: 통계적 데이터 분석
- **입력**: 가격, 거래량, 지표, 과거 성과
- **출력**: 통계적 확률, 기대값
- **특징**: 과거 거래 학습 기반 예측

### 4. 제논 (스토익)
- **역할**: 리스크 관리
- **입력**: 모든 에이전트 분석 결과
- **출력**: 손절가, 포지션 크기, 리스크 평가
- **특징**: 자본 보존 최우선

### 5. 솔론 (신디사이저)
- **역할**: 최종 의사결정
- **입력**: 4개 에이전트 보고서
- **출력**: BUY/SELL/HOLD/CLOSE_POSITION
- **특징**: 충돌 해결 및 동적 가중치

## 🔧 핵심 컴포넌트

### 1. Position State Manager
```python
# 포지션 상태의 Single Source of Truth
class PositionStateManager:
    - Binance API (실시간)
    - Trading Context (거래 맥락)
    - Database (이력 추적)
```

### 2. Trading Context
```python
# 거래 연속성 유지
class TradingContext:
    - Trading Thesis (거래 근거)
    - Scenario Tracking (시나리오 추적)
    - Invalidation Rules (무효화 조건)
```

### 3. Enhanced Conflict Resolver V2
```python
# 지능적 충돌 해결
class EnhancedConflictResolverV2:
    - Market Regime Detection
    - Conflict Classification
    - Dynamic Weight Calculation
```

### 4. Trade History Sync
```python
# 거래 내역 동기화
class TradeHistorySync:
    - Manual Trade Detection
    - Exit Price Tracking
    - Data Labeling
```

## 📊 데이터 플로우

### 1. 실시간 데이터 수집
```
바이낸스 API → BinanceConnector → 각 에이전트
                    ↓
              차트 캡처 (Selenium)
                    ↓
              스크린샷 저장
```

### 2. 분석 프로세스
```
차트/데이터 → 에이전트 분석 → JSON 보고서
                    ↓
              ConflictResolver
                    ↓
              Synthesizer
                    ↓
              거래 결정
```

### 3. 거래 실행
```
거래 결정 → TradeExecutor → 바이낸스 API
              ↓
        Position Update
              ↓
        Database Save
```

## 💾 데이터 저장

### 1. 데이터베이스 구조
```sql
-- 거래 기록
trade_records:
  - trade_id (PRIMARY KEY)
  - entry_time, exit_time
  - direction, leverage
  - pnl_percent, outcome
  
-- 포지션 상태
positions:
  - position_id
  - status (OPEN/CLOSED)
  - unrealized_pnl
  
-- 에이전트 점수
agent_scores:
  - timestamp
  - chartist, journalist, quant, stoic
```

### 2. Trading Context
```json
{
  "trade_id": "TRD_20250706_123456",
  "thesis": {
    "entry_reason": "강한 하락 추세",
    "primary_scenario": "지지선 붕괴",
    "target_price": 145.0,
    "stop_loss": 150.5
  }
}
```

## 🔄 시스템 동작 흐름

### 1. 정상 거래 플로우
```
1. 차트 캡처 (5분마다)
2. 4개 에이전트 병렬 분석
3. 충돌 해결 및 가중치 조정
4. 신디사이저 최종 결정
5. 거래 실행 또는 대기
6. 포지션 모니터링
```

### 2. 포지션 관리 플로우
```
1. 실시간 포지션 체크
2. Trading Context 확인
3. 시나리오 진행 평가
4. 손절/익절 자동 관리
5. 청산 또는 유지 결정
```

### 3. 재시작 복구 플로우
```
1. Trade History Sync
2. Position State 복구
3. Trading Context 로드
4. 정상 동작 재개
```

## 🛡️ 안전 장치

### 1. 리스크 관리
- 거래당 최대 손실: 자본의 1.5%
- 레버리지 제한: 1-3배
- 포지션 크기: 자본의 5-10%

### 2. 시스템 보호
- API Rate Limit 관리
- 에러 자동 복구
- 중복 거래 방지
- 수동 거래 통합

### 3. 데이터 무결성
- Single Source of Truth
- 트랜잭션 보장
- 백업 및 복구

## 📈 성능 최적화

### 1. 병렬 처리
- 4개 에이전트 동시 실행
- 비동기 API 호출
- 멀티스레드 차트 캡처

### 2. 캐싱
- API 응답 캐싱
- 차트 이미지 캐싱
- 계산 결과 캐싱

### 3. 리소스 관리
- 메모리 사용량 모니터링
- API 호출 최적화
- 로그 파일 자동 정리

---

*최종 수정: 2025-07-06*