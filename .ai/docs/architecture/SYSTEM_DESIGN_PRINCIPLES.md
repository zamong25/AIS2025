# 델파이 트레이딩 시스템 설계 원칙

## 1. 거래 생명주기 (Trade Lifecycle)

### 현재 시스템 설계
- **거래 저장 시점**: 포지션 청산(종료) 시에만 데이터베이스에 저장
- **PENDING 상태**: 사용하지 않음 (레거시 코드는 남아있으나 실제로 동작하지 않음)
- **거래 ID**: `DELPHI_YYYYMMDD_HHMMSS` 형식으로 생성

### 거래 흐름
1. **포지션 진입**
   - 메모리에만 포지션 정보 유지
   - 데이터베이스에 저장하지 않음
   
2. **포지션 모니터링**
   - 실시간으로 손익 추적
   - MDD (최대 낙폭) 모니터링
   - 포지션 트리거 관리
   
3. **포지션 청산**
   - 청산 시점에 전체 거래 정보를 데이터베이스에 저장
   - outcome 필드: TP_HIT, SL_HIT, TIME_EXIT, MANUAL_EXIT 등으로 구분

## 2. 로깅 시스템 가이드라인

### 로거 생성 패턴
```python
# 클래스가 있는 모듈
logger = logging.getLogger('ClassName')

# 함수만 있는 유틸리티 모듈
logger = logging.getLogger(__name__)
```

### 로깅 레벨 가이드
- **ERROR**: 시스템 중단 또는 중요한 기능 실패
- **WARNING**: 주의가 필요한 상황 (예: API 제한, 재시도)
- **INFO**: 주요 이벤트 (거래 실행, 분석 완료, 시스템 시작/종료)
- **DEBUG**: 개발/디버깅용 상세 정보

## 3. Import 구조

### 표준 import 순서
1. 표준 라이브러리
2. 서드파티 라이브러리
3. 프로젝트 내부 모듈

### 프로젝트 내부 import
- 절대 경로 사용 권장
- sys.path 조작은 최소화

## 4. 주석 가이드라인

### 언어
- 한글 사용 (시스템 일관성 유지)
- 이모지 사용 금지 (Windows 인코딩 문제)

### 주석 종류
- 모듈 독스트링: 파일 최상단에 모듈 설명
- 클래스 독스트링: 클래스의 목적과 책임
- 함수 독스트링: Args, Returns, Raises 명시
- 인라인 주석: 복잡한 로직 설명

## 5. 에러 처리

### 원칙
- 명확한 에러 메시지 (무엇이 왜 실패했는지)
- 적절한 로깅 레벨 사용
- 필요시 재시도 로직 구현

### 패턴
```python
try:
    # 작업 수행
except SpecificException as e:
    logger.error(f"작업 실패 - 구체적인 이유: {e}")
    # 필요시 복구 또는 재시도
```

## 6. 데이터베이스 관리

### SQLite 설정
- WAL 모드 사용 (동시성 향상)
- 재시도 로직 구현 (파일 잠금 처리)
- 적절한 인덱스 생성

### 트랜잭션 관리
- 명시적 트랜잭션 사용
- 에러 시 롤백 보장
- finally 블록에서 연결 종료

## 7. 시스템 모듈 구조

### 핵심 모듈
- `main.py`: 시스템 오케스트레이터
- `agents/`: AI 에이전트들 (차티스트, 저널리스트, 퀀트, 스토익, 신디사이저)
- `trading/`: 거래 실행 관련 (실행기, OCO 관리, 슬리피지 계산)
- `data/`: 데이터 관리 (데이터베이스, 바이낸스 연동, 시장 분석)
- `monitoring/`: 모니터링 시스템 (포지션, MDD, 리포트)
- `utils/`: 유틸리티 (디스코드 알림, 성능 최적화, 로깅)

### 확장 모듈
- `integration/`: 시나리오 학습 시스템
- `analysis/`: 주간 분석 및 리포트

## 8. 성능 고려사항

### 캐싱
- API 응답 캐싱 (15분)
- 자주 사용되는 계산 결과 캐싱

### 비동기 처리
- 독립적인 작업은 병렬 처리
- 에이전트 분석은 동시 실행

### 리소스 관리
- 데이터베이스 연결 풀링
- 메모리 사용량 모니터링

## 9. 보안 고려사항

### API 키 관리
- 환경 변수 사용 (.env 파일)
- 절대 하드코딩 금지
- 로그에 민감 정보 노출 금지

### 데이터 보호
- 거래 정보 암호화 고려
- 백업 자동화 구현

## 10. 테스트 가이드

### 테스트 원칙
- 전체 시스템 테스트 우선
- 단위 테스트는 /temporary 폴더 활용
- 테스트 후 임시 파일 삭제

### 테스트 환경
- 바이낸스 테스트넷 활용
- 모의 데이터로 시나리오 테스트